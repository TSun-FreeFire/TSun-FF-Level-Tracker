<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free Fire Level Tracker | Sage Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Space+Grotesk:wght@300;400;600;700&display=swap');

        :root {
            --primary: #E6EFEA;
            --secondary: #B7C9BF;
            --accent: #7FA69A;
            --accent-dark: #6a8d82;
            --text-dark: #2F3E3A;
            --text-dim: #4a5d58;
            --border-color: #D3E0DA;
            --white: #ffffff;
        }

        body {
            background-color: var(--primary);
            color: var(--text-dark);
            font-family: 'Outfit', sans-serif;
            background-image:
                radial-gradient(circle at 0% 0%, rgba(127, 166, 154, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 100% 100%, rgba(183, 201, 191, 0.2) 0%, transparent 50%);
            background-attachment: fixed;
        }

        .ff-font {
            font-family: 'Space Grotesk', sans-serif;
        }

        .glass-card {
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(47, 62, 58, 0.05);
        }

        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .glass-card:hover {
            transform: translateY(-6px);
            border-color: var(--secondary);
            box-shadow: 0 20px 40px rgba(47, 62, 58, 0.1);
        }

        .glass-card:hover::before {
            opacity: 1;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--white);
            padding: 12px 28px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(127, 166, 154, 0.3);
        }

        .btn-primary:hover {
            background: var(--accent-dark);
            box-shadow: 0 8px 25px rgba(127, 166, 154, 0.4);
            transform: translateY(-2px);
        }

        .filter-btn {
            background: var(--white);
            border: 1px solid var(--border-color);
            color: var(--text-dim);
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
        }

        .filter-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--white);
        }

        .progress-bar {
            height: 8px;
            background: var(--primary);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--secondary));
            border-radius: 4px;
            transition: width 1s ease-out;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--secondary);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .modal-bg {
            background: rgba(47, 62, 58, 0.4);
            backdrop-filter: blur(8px);
        }

        .input-field {
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 14px 20px;
            color: var(--text-dark);
            transition: all 0.3s;
        }

        .input-field:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(127, 166, 154, 0.1);
            outline: none;
        }

        .search-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 8px 12px;
            transition: all 0.3s;
            min-width: 320px;
        }

        .search-container:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(127, 166, 154, 0.1);
        }

        .search-type-dropdown {
            position: relative;
        }

        .search-type-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .search-type-btn:hover {
            background: var(--secondary);
            border-color: var(--accent);
        }

        .search-type-btn i {
            font-size: 0.7rem;
            transition: transform 0.2s;
        }

        .search-type-btn.active i {
            transform: rotate(180deg);
        }

        .search-dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(47, 62, 58, 0.15);
            overflow: hidden;
            min-width: 140px;
            z-index: 100;
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .search-dropdown-menu.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .search-dropdown-item {
            padding: 10px 16px;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-dropdown-item:hover {
            background: var(--primary);
            color: var(--accent);
        }

        .search-dropdown-item.selected {
            background: var(--accent);
            color: var(--white);
        }

        .search-input-wrapper {
            flex: 1;
            position: relative;
        }

        .search-input {
            width: 100%;
            border: none;
            background: transparent;
            color: var(--text-dark);
            font-size: 0.875rem;
            font-weight: 500;
            padding: 4px 24px 4px 8px;
            outline: none;
        }

        .search-input::placeholder {
            color: var(--text-dim);
            opacity: 0.6;
        }

        .search-clear-btn {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
            opacity: 0;
            pointer-events: none;
        }

        .search-clear-btn.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .search-clear-btn:hover {
            color: var(--accent);
            background: var(--primary);
        }

        .search-icon {
            color: var(--accent);
            font-size: 0.875rem;
        }

        @media (max-width: 768px) {
            .search-container {
                min-width: 200px;
            }
        }
    </style>
</head>

<body class="min-h-screen pb-12">
    <!-- Header -->
    <header class="border-b border-[#D3E0DA] bg-white/80 backdrop-blur-md sticky top-0 z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 h-20 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div
                    class="w-12 h-12 bg-gradient-to-br from-[#7FA69A] to-[#B7C9BF] rounded-xl flex items-center justify-center shadow-lg shadow-[#7FA69A]/20">
                    <i class="fas fa-leaf text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="ff-font text-xl md:text-2xl font-bold tracking-tight text-[#2F3E3A]">
                        TSun <span class="text-[#7FA69A]">LEVEL TRACKER</span>
                    </h1>
                    <p class="text-[10px] text-[#4a5d58] font-bold uppercase tracking-[0.3em]">TSun Analytics</p>
                </div>
            </div>

            <div class="flex items-center gap-2 md:gap-3">
                <div class="hidden md:flex bg-[#E6EFEA] p-1 rounded-lg border border-[#D3E0DA]">
                    <button id="gridViewBtn" class="px-4 py-1.5 rounded-md transition-all bg-[#7FA69A] text-white"
                        onclick="switchView('grid')">
                        <i class="fas fa-th-large"></i>
                    </button>
                    <button id="listViewBtn"
                        class="px-4 py-1.5 rounded-md transition-all text-[#4a5d58] hover:text-[#2F3E3A]"
                        onclick="switchView('list')">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
                <button onclick="syncAll()"
                    class="bg-white text-[#7FA69A] border border-[#D3E0DA] px-4 py-2.5 rounded-xl text-sm font-bold hover:bg-[#E6EFEA] transition-all flex items-center gap-2">
                    <i class="fas fa-sync-alt"></i> <span class="hidden sm:inline">Sync All</span>
                </button>
                <button onclick="toggleModal(true)" class="btn-primary">
                    <i class="fas fa-plus"></i> <span class="hidden sm:inline">Add UIDs</span>
                </button>

                <!-- Search Bar -->
                <div class="search-container">
                    <div class="search-type-dropdown">
                        <button class="search-type-btn" onclick="toggleSearchDropdown()">
                            <span id="searchTypeLabel">Name</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="search-dropdown-menu" id="searchDropdown">
                            <div class="search-dropdown-item selected" onclick="setSearchType('name')">
                                <i class="fas fa-user"></i> Name
                            </div>
                            <div class="search-dropdown-item" onclick="setSearchType('server')">
                                <i class="fas fa-globe"></i> Server
                            </div>
                            <div class="search-dropdown-item" onclick="setSearchType('id')">
                                <i class="fas fa-id-card"></i> ID
                            </div>
                        </div>
                    </div>
                    <div class="search-input-wrapper">
                        <input type="text" class="search-input" id="searchInput" placeholder="Search players..."
                            oninput="handleSearch()">
                        <button class="search-clear-btn" id="searchClearBtn" onclick="clearSearch()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <i class="fas fa-search search-icon"></i>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 mt-10">
        <!-- Manual Input -->
        <section class="mb-12">
            <div class="glass-card p-8">
                <h2 class="ff-font text-xs font-bold text-[#7FA69A] mb-6 uppercase tracking-[0.2em]">Single Operative
                    Entry</h2>
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="uidInput" name="uid-input-single"
                        placeholder="ENTER PLAYER UID (e.g. 123456789)" class="flex-1 input-field ff-font text-sm"
                        autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly');">
                    <button onclick="addUidFromInput()" class="btn-primary px-10">
                        Deploy Tracker
                    </button>
                </div>
            </div>
        </section>

        <!-- Tracker Section -->
        <section>
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h2 class="ff-font text-3xl font-bold text-[#2F3E3A] uppercase tracking-tight">Active Operatives
                    </h2>
                    <p class="text-sm text-[#4a5d58] mt-1">Real-time status tracking for deployed units</p>
                </div>
                <div class="flex items-center gap-3">
                    <button id="filterBtn" onclick="toggleFilter()" class="filter-btn">
                        <i class="fas fa-filter mr-2"></i> Level > 8
                    </button>
                    <span id="playersCount"
                        class="bg-[#7FA69A]/10 text-[#7FA69A] border border-[#7FA69A]/20 px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider">0
                        TRACKED</span>
                </div>
            </div>

            <div id="loadingIndicator" class="hidden py-12 text-center">
                <div class="inline-block relative">
                    <div class="w-16 h-16 border-4 border-[#7FA69A]/20 border-t-[#7FA69A] rounded-full animate-spin">
                    </div>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <i class="fas fa-satellite text-[#7FA69A] animate-pulse"></i>
                    </div>
                </div>
                <p class="mt-6 ff-font text-sm text-[#4a5d58] uppercase tracking-widest">Synchronizing Accounts Data...
                </p>
            </div>

            <!-- Display Containers -->
            <div id="playersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
            <div id="playersList" class="hidden space-y-4"></div>

            <!-- Empty State -->
            <div id="emptyState"
                class="py-32 text-center border-2 border-dashed border-[#D3E0DA] rounded-[2rem] bg-white/50">
                <div
                    class="w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-6 border border-[#D3E0DA] shadow-sm">
                    <i class="fas fa-user-secret text-3xl text-[#B7C9BF]"></i>
                </div>
                <h3 class="ff-font text-xl text-[#4a5d58] uppercase tracking-tight">No Active Signals</h3>
                <p class="text-[#4a5d58] mt-2 max-w-xs mx-auto">Deploy player UIDs to initiate high-frequency level
                    tracking protocols.</p>
            </div>
        </section>
    </main>

    <!-- Import Modal -->
    <div id="uidModal" class="hidden fixed inset-0 z-50 modal-bg flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-xl shadow-2xl">
            <div class="p-6 bg-white flex justify-between items-center border-b border-[#D3E0DA]">
                <h3 class="ff-font text-xl font-bold text-[#2F3E3A] uppercase tracking-tight">Batch Signal Import</h3>
                <button onclick="toggleModal(false)"
                    class="text-[#4a5d58] hover:text-[#2F3E3A] text-2xl transition-colors">&times;</button>
            </div>
            <div class="p-8">
                <p class="text-sm text-[#4a5d58] mb-6 leading-relaxed">Paste multiple UIDs separated by commas, spaces,
                    or new lines. System also accepts JSON array formats for advanced deployment.</p>
                <textarea id="uidTextarea" name="uid-textarea-batch" rows="6"
                    class="w-full input-field ff-font text-sm mb-6" placeholder="1234567890&#10;1234567890&#10;..."
                    autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly');"></textarea>

                <div class="mb-6 p-4 bg-[#E6EFEA] rounded-xl border border-[#D3E0DA]">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" id="adminMode"
                            class="w-5 h-5 rounded border-[#D3E0DA] text-[#7FA69A] focus:ring-[#7FA69A]"
                            onchange="toggleAdminPass(this.checked)">
                        <span class="text-sm font-bold text-[#2F3E3A] uppercase tracking-wider">Admin Deployment (Neon
                            DB)</span>
                    </label>
                    <div id="adminPassContainer" class="hidden mt-4">
                        <input type="password" id="adminPassword" placeholder="ADMIN ACCESS KEY"
                            class="w-full input-field ff-font text-sm">
                    </div>
                </div>

                <div class="flex gap-4">
                    <button onclick="toggleModal(false)"
                        class="flex-1 py-4 bg-white border border-[#D3E0DA] text-[#4a5d58] font-bold rounded-xl uppercase hover:bg-[#E6EFEA] transition-all text-sm tracking-wider">Abort</button>
                    <button onclick="importUids()"
                        class="flex-1 py-4 bg-[#7FA69A] text-white font-bold rounded-xl uppercase hover:bg-[#6a8d82] transition-all shadow-lg shadow-[#7FA69A]/20 text-sm tracking-wider">Initialize</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- State Management ---
        const API_BASE = '/api';
        const LOCAL_UIDS_KEY = 'tsun_local_uids';

        const LEVEL_DATA = {
            "Level": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100],
            "EXP": [0, 48, 202, 544, 1012, 1844, 2792, 3800, 4870, 6004, 7192, 8448, 9776, 11140, 12566, 14060, 15610, 17224, 18902, 20632, 22424, 24728, 26192, 28166, 30200, 32294, 34448, 37804, 41174, 44870, 48852, 53334, 58566, 64096, 69994, 76460, 83108, 91128, 99322, 108092, 120144, 133266, 147472, 162760, 179126, 196572, 215368, 235516, 257010, 279860, 304056, 348318, 394982, 444044, 495508, 549364, 633756, 721744, 813336, 908522, 1041438, 1180352, 1325256, 1476184, 1634300, 1840946, 2056594, 2281242, 2514880, 2757530, 3059506, 3372284, 3699456, 4041030, 4397020, 4829104, 5282204, 5756304, 6251404, 6767504, 7381324, 8043154, 8752952, 9510808, 10316638, 11277190, 12360748, 13360304, 14482858, 15659418, 17026708, 18453688, 19941280, 21488570, 23095858, 24763138, 26490138, 28277708, 30124996, 32032284]
        };

        let players = [];
        let currentView = 'grid';
        let activeRequests = 0;
        let filterAbove8 = false;
        let searchType = 'name';
        let searchQuery = '';

        // Region code to name mapping
        const REGION_MAP = {
            'EU': 'Europe',
            'ME': 'Middle East',
            'ID': 'Indonesia',
            'TH': 'Thailand',
            'VN': 'Vietnam',
            'SG': 'Singapore',
            'BD': 'Bangladesh',
            'PK': 'Pakistan',
            'MY': 'Malaysia',
            'PH': 'Philippines',
            'RU': 'Russia',
            'AFR': 'Africa',
            'BR': 'Brazil',
            'US': 'United States',
            'SAC': 'South America Central',
            'NA': 'North America',
            'IND': 'India'
        };

        // Reverse mapping for search (region name to code)
        const REGION_NAME_TO_CODE = Object.entries(REGION_MAP).reduce((acc, [code, name]) => {
            acc[name.toLowerCase()] = code;
            return acc;
        }, {});

        // --- Core Functions ---
        async function init() {
            await fetchPlayers();
        }

        async function fetchPlayers() {
            updateLoading(1);
            try {
                // Fetch from Neon DB
                const res = await fetch(`${API_BASE}/players`);
                const dbPlayers = await res.json();

                // Fetch local UIDs from localStorage
                const localUids = getLocalUids();
                const allPlayers = [...dbPlayers];

                // Fetch data for local UIDs from external API directly (or we could add a proxy endpoint)
                for (const uid of localUids) {
                    if (!allPlayers.find(p => p.uid === uid)) {
                        const localData = await fetchExternalData(uid);
                        if (localData) allPlayers.push(localData);
                    }
                }

                players = allPlayers;
                renderPlayers();
            } catch (e) {
                console.error("Error fetching players:", e);
            } finally {
                updateLoading(-1);
            }
        }

        async function fetchExternalData(uid) {
            try {
                const res = await fetch(`https://fffinfo.tsunstudio.pw/get?uid=${uid}`);
                const data = await res.json();
                if (data && data.AccountInfo) {
                    return {
                        uid,
                        name: data.AccountInfo.AccountName,
                        level: data.AccountInfo.AccountLevel,
                        exp: data.AccountInfo.AccountEXP,
                        region: data.AccountInfo.AccountRegion,
                        likes: data.AccountInfo.AccountLikes,
                        last_update: new Date().toLocaleTimeString(),
                        fetched: true
                    };
                }
            } catch (e) {
                console.error("External API Error:", e);
            }
            return null;
        }

        function getLocalUids() {
            const cached = localStorage.getItem(LOCAL_UIDS_KEY);
            return cached ? JSON.parse(cached) : [];
        }

        function saveLocalUid(uid) {
            const uids = getLocalUids();
            if (!uids.includes(uid)) {
                uids.push(uid);
                localStorage.setItem(LOCAL_UIDS_KEY, JSON.stringify(uids));
            }
        }

        function removeLocalUid(uid) {
            const uids = getLocalUids().filter(u => u !== uid);
            localStorage.setItem(LOCAL_UIDS_KEY, JSON.stringify(uids));
        }

        async function syncAll() {
            updateLoading(1);
            try {
                await fetch(`${API_BASE}/sync`, { method: 'POST' });
                await fetchPlayers();
            } catch (e) {
                console.error("Sync All Error:", e);
            } finally {
                updateLoading(-1);
            }
        }

        async function syncPlayer(uid) {
            updateLoading(1);
            try {
                await fetch(`${API_BASE}/sync/${uid}`, { method: 'POST' });
                await fetchPlayers();
            } catch (e) {
                console.error("Sync Player Error:", e);
            } finally {
                updateLoading(-1);
            }
        }

        function toggleFilter() {
            filterAbove8 = !filterAbove8;
            const btn = document.getElementById('filterBtn');
            btn.classList.toggle('active', filterAbove8);
            renderPlayers();
        }

        function toggleSearchDropdown() {
            const dropdown = document.getElementById('searchDropdown');
            const btn = document.querySelector('.search-type-btn');
            const isActive = dropdown.classList.contains('active');

            dropdown.classList.toggle('active', !isActive);
            btn.classList.toggle('active', !isActive);
        }

        function setSearchType(type) {
            searchType = type;
            const label = document.getElementById('searchTypeLabel');
            const items = document.querySelectorAll('.search-dropdown-item');

            // Update label
            const labels = { name: 'Name', server: 'Server', id: 'ID' };
            label.textContent = labels[type];

            // Update selected state
            items.forEach(item => {
                const itemType = item.textContent.trim().toLowerCase();
                item.classList.toggle('selected', itemType === type);
            });

            toggleSearchDropdown();
            handleSearch(); // Re-run search with new type
        }

        function handleSearch() {
            const input = document.getElementById('searchInput');
            const clearBtn = document.getElementById('searchClearBtn');
            searchQuery = input.value.trim().toLowerCase();

            // Show/hide clear button
            clearBtn.classList.toggle('visible', searchQuery.length > 0);

            renderPlayers();
        }

        function clearSearch() {
            const input = document.getElementById('searchInput');
            input.value = '';
            searchQuery = '';
            document.getElementById('searchClearBtn').classList.remove('visible');
            renderPlayers();
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (e) {
            const dropdown = document.getElementById('searchDropdown');
            const btn = document.querySelector('.search-type-btn');
            if (dropdown && !dropdown.contains(e.target) && !btn.contains(e.target)) {
                dropdown.classList.remove('active');
                btn.classList.remove('active');
            }
        });

        function toggleAdminPass(show) {
            document.getElementById('adminPassContainer').classList.toggle('hidden', !show);
        }

        async function addUidFromInput() {
            const val = document.getElementById('uidInput').value.trim();
            if (val) {
                // Default to local storage for single input unless we add a toggle there too
                // For simplicity, single input is always local
                saveLocalUid(val);
                await fetchPlayers();
                document.getElementById('uidInput').value = '';
            }
        }

        async function importUids() {
            const raw = document.getElementById('uidTextarea').value.trim();
            const isAdmin = document.getElementById('adminMode').checked;
            const password = document.getElementById('adminPassword').value;

            let newUids = [];
            try {
                if (raw.startsWith('[')) newUids = JSON.parse(raw);
                else newUids = raw.split(/[\n,\s]+/).filter(u => u);
            } catch (e) {
                newUids = raw.split(/[\n,\s]+/).filter(u => u);
            }

            if (isAdmin) {
                updateLoading(1);
                try {
                    const res = await fetch(`${API_BASE}/adminaddplayers`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ uids: newUids, password })
                    });
                    if (!res.ok) throw new Error(await res.text());
                    alert("Admin sync initiated for database.");
                } catch (e) {
                    alert("Admin Error: " + e.message);
                } finally {
                    updateLoading(-1);
                }
            } else {
                newUids.forEach(uid => saveLocalUid(uid.toString()));
            }

            toggleModal(false);
            document.getElementById('uidTextarea').value = '';
            document.getElementById('adminPassword').value = '';
            await fetchPlayers();
        }

        async function removePlayer(uid, isAdminAdded) {
            if (isAdminAdded) {
                const password = prompt("Enter Admin Password to delete from Database:");
                if (!password) return;

                updateLoading(1);
                try {
                    const res = await fetch(`${API_BASE}/deleteplayers`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ uid, password })
                    });
                    if (!res.ok) throw new Error(await res.text());
                } catch (e) {
                    alert("Delete Error: " + e.message);
                } finally {
                    updateLoading(-1);
                }
            } else {
                removeLocalUid(uid);
            }
            await fetchPlayers();
        }

        function calculateProgress(level, currentExp) {
            if (level == null || currentExp == null) return { pct: 0, next: '...', max: '...' };

            const idx = LEVEL_DATA.Level.indexOf(level);
            if (idx === -1 || idx === LEVEL_DATA.Level.length - 1) return { pct: 100, next: 'MAX', max: 'MAX' };

            const startExp = LEVEL_DATA.EXP[idx];
            const endExp = LEVEL_DATA.EXP[idx + 1];
            const totalInLevel = endExp - startExp;
            const currentInLevel = currentExp - startExp;

            return {
                pct: Math.max(0, Math.min(100, (currentInLevel / totalInLevel) * 100)),
                next: endExp - currentExp,
                max: endExp
            };
        }

        // --- UI Utilities ---
        function formatNumber(num) {
            if (num == null) return "...";
            if (typeof num !== 'number') return num;
            return num.toLocaleString();
        }

        function renderPlayers() {
            const grid = document.getElementById('playersGrid');
            const list = document.getElementById('playersList');
            const empty = document.getElementById('emptyState');
            const count = document.getElementById('playersCount');

            let displayPlayers = [...players].sort((a, b) => (b.level || 0) - (a.level || 0));

            // Apply level filter
            if (filterAbove8) {
                displayPlayers = displayPlayers.filter(p => (p.level || 0) > 8);
            }

            // Apply search filter
            if (searchQuery) {
                displayPlayers = displayPlayers.filter(p => {
                    if (searchType === 'name') {
                        return (p.name || '').toLowerCase().includes(searchQuery);
                    } else if (searchType === 'server') {
                        const region = (p.region || '').toLowerCase();
                        const regionName = REGION_MAP[p.region.toUpperCase()];

                        // Check if search matches region code OR full region name
                        return region.includes(searchQuery) ||
                            (regionName && regionName.toLowerCase().includes(searchQuery));
                    } else if (searchType === 'id') {
                        return (p.uid || '').toString().includes(searchQuery);
                    }
                    return false;
                });
            }

            count.innerText = `${displayPlayers.length} TRACKED`;

            if (displayPlayers.length === 0) {
                empty.classList.remove('hidden');
                grid.classList.add('hidden');
                list.classList.add('hidden');
                return;
            }

            empty.classList.add('hidden');
            grid.classList.toggle('hidden', currentView !== 'grid');
            list.classList.toggle('hidden', currentView !== 'list');

            const container = currentView === 'grid' ? grid : list;
            container.innerHTML = displayPlayers.map((p, idx) => {
                const prog = calculateProgress(p.level, p.exp);
                const safeName = p.name || 'CONNECTING...';
                const safeLevel = p.level != null ? p.level : '??';
                const safeExp = formatNumber(p.exp);
                const safeMaxExp = formatNumber(prog.max);
                const safeNext = formatNumber(prog.next);
                // Display region code, fallback to original if not in mapping
                const regionCode = p.region ? p.region.toUpperCase() : 'PENDING';
                const safeRegion = REGION_MAP[regionCode] ? regionCode : (p.region || 'PENDING');
                const safeLikes = formatNumber(p.likes);
                const safeUpdate = p.last_update || '--:--';
                const isAdmin = p.is_admin_added;

                if (currentView === 'grid') {
                    return `
                    <div class="glass-card p-6 relative group animate-fade-in" style="animation-delay: ${idx * 0.05}s">
                        <div class="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-all">
                            <button onclick="syncPlayer('${p.uid}')" class="text-[#4a5d58] hover:text-[#7FA69A]">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button onclick="removePlayer('${p.uid}', ${isAdmin})" class="text-[#4a5d58] hover:text-[#7FA69A]">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-14 h-14 bg-[#E6EFEA] rounded-xl flex items-center justify-center border border-[#D3E0DA] relative">
                                <span class="ff-font text-2xl font-bold text-[#2F3E3A]">${safeLevel}</span>
                                <div class="absolute -bottom-1 -right-1 w-4 h-4 ${isAdmin ? 'bg-amber-500' : 'bg-[#7FA69A]'} rounded-full border-2 border-white" title="${isAdmin ? 'Database Tracked' : 'Local Tracked'}"></div>
                            </div>
                            <div class="min-w-0">
                                <h3 class="ff-font font-bold text-[#2F3E3A] uppercase text-lg leading-tight truncate pr-4">${safeName}</h3>
                                <p class="text-[10px] text-[#4a5d58] font-bold tracking-widest uppercase mt-1">${safeRegion} • ID: ${p.uid}</p>
                            </div>
                        </div>
                        <div class="space-y-5">
                            <div>
                                <div class="flex justify-between text-[10px] font-bold uppercase mb-2 tracking-wider">
                                    <span class="text-[#4a5d58]">Combat Experience</span>
                                    <span class="text-[#7FA69A]">${safeExp} / ${safeMaxExp}</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${prog.pct}%"></div>
                                </div>
                                <p class="text-[10px] text-right mt-2 text-[#7FA69A] font-bold uppercase italic tracking-tight">
                                    ${prog.next === 'MAX' ? 'LEVEL LIMIT REACHED' : `${safeNext} EXP TO LVL ${p.level ? p.level + 1 : '?'}`}
                                </p>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-[#E6EFEA] p-3 rounded-lg border border-[#D3E0DA]">
                                    <p class="text-[9px] uppercase text-[#4a5d58] font-bold mb-1">Total Likes</p>
                                    <p class="text-sm font-bold text-[#2F3E3A] flex items-center gap-2">
                                        <i class="fas fa-heart text-[#7FA69A]"></i> ${safeLikes}
                                    </p>
                                </div>
                                <div class="bg-[#E6EFEA] p-3 rounded-lg border border-[#D3E0DA]">
                                    <p class="text-[9px] uppercase text-[#4a5d58] font-bold mb-1">Last Sync</p>
                                    <p class="text-sm font-bold text-[#2F3E3A] flex items-center gap-2">
                                        <i class="fas fa-sync-alt text-[#4a5d58]"></i> ${safeUpdate}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>`;
                } else {
                    return `
                    <div class="glass-card p-5 flex flex-col md:flex-row items-center gap-6 animate-fade-in" style="animation-delay: ${idx * 0.05}s">
                        <div class="ff-font text-3xl font-black text-[#7FA69A] w-14 h-14 bg-[#E6EFEA] rounded-lg flex items-center justify-center border border-[#D3E0DA]">${safeLevel}</div>
                        <div class="flex-1 min-w-0">
                            <h3 class="ff-font font-bold text-[#2F3E3A] uppercase truncate text-lg">${safeName}</h3>
                            <p class="text-xs text-[#4a5d58] font-medium">${safeRegion} • ${p.uid} ${isAdmin ? '<span class="text-amber-600 font-bold ml-2">[DB]</span>' : ''}</p>
                        </div>
                        <div class="w-full md:w-72">
                            <div class="flex justify-between text-[10px] font-bold mb-2 uppercase tracking-wider">
                                <span class="text-[#4a5d58]">EXP PROGRESS</span>
                                <span class="text-[#7FA69A]">${Math.round(prog.pct)}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${prog.pct}%"></div>
                            </div>
                        </div>
                        <div class="flex items-center gap-6">
                            <div class="text-right hidden sm:block">
                                <p class="text-[9px] text-[#4a5d58] uppercase font-bold mb-0.5">Next Level</p>
                                <p class="text-sm font-bold text-[#2F3E3A]">${safeNext}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="syncPlayer('${p.uid}')" class="w-10 h-10 rounded-lg flex items-center justify-center text-[#4a5d58] hover:text-[#7FA69A] hover:bg-[#7FA69A]/10 transition-all">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button onclick="removePlayer('${p.uid}', ${isAdmin})" class="w-10 h-10 rounded-lg flex items-center justify-center text-[#4a5d58] hover:text-[#7FA69A] hover:bg-[#7FA69A]/10 transition-all">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>`;
                }
            }).join('');
        }

        function switchView(view) {
            currentView = view;
            const gridBtn = document.getElementById('gridViewBtn');
            const listBtn = document.getElementById('listViewBtn');

            if (view === 'grid') {
                gridBtn.classList.add('bg-[#7FA69A]', 'text-white');
                gridBtn.classList.remove('text-[#4a5d58]');
                listBtn.classList.remove('bg-[#7FA69A]', 'text-white');
                listBtn.classList.add('text-[#4a5d58]');
            } else {
                listBtn.classList.add('bg-[#7FA69A]', 'text-white');
                listBtn.classList.remove('text-[#4a5d58]');
                gridBtn.classList.remove('bg-[#7FA69A]', 'text-white');
                gridBtn.classList.add('text-[#4a5d58]');
            }
            renderPlayers();
        }

        function toggleModal(show) {
            document.getElementById('uidModal').classList.toggle('hidden', !show);
        }

        function updateLoading(delta) {
            activeRequests += delta;
            document.getElementById('loadingIndicator').classList.toggle('hidden', activeRequests <= 0);
        }

        window.onload = init;
    </script>
</body>

</html>